# EXPERIMENTAL - Combined Build & Tests workflow
# Move to .github/workflows/ and update triggers when ready to use

name: CI

on:
  workflow_dispatch:  # Manual trigger only for now

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.head.ref || github.ref_name }}
  cancel-in-progress: true

jobs:
  # ============================================
  # BUILD JOBS
  # ============================================

  build-ios:
    name: Build (iOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Find latest iOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes ios --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No iOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available iOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=iOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Build for iOS
      timeout-minutes: 15
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  build-macos:
    name: Build (macOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build for macOS
      timeout-minutes: 15
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme SwiftEmoji-Package \
          -destination "platform=macOS" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  build-tvos:
    name: Build (tvOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest tvOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes tvos --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No tvOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available tvOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=tvOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Build for tvOS
      timeout-minutes: 15
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  build-watchos:
    name: Build (watchOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest watchOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes watchos --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No watchOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available watchOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=watchOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Build for watchOS
      timeout-minutes: 15
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  build-visionos:
    name: Build (visionOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest visionOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes xros --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No visionOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available visionOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=visionOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Build for visionOS
      timeout-minutes: 15
      run: |
        set -o pipefail
        xcodebuild build \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  # ============================================
  # TEST JOBS
  # ============================================

  test-ios:
    name: Tests (iOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest iOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes ios --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No iOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available iOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=iOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Run tests on iOS
      timeout-minutes: 10
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  test-macos:
    name: Tests (macOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run tests on macOS
      timeout-minutes: 10
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme SwiftEmoji-Package \
          -destination "platform=macOS" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  test-tvos:
    name: Tests (tvOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest tvOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes tvos --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No tvOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available tvOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=tvOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Run tests on tvOS
      timeout-minutes: 10
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  test-watchos:
    name: Tests (watchOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest watchOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes watchos --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No watchOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available watchOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=watchOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Run tests on watchOS
      timeout-minutes: 10
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

  test-visionos:
    name: Tests (visionOS)
    runs-on: macos-26

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Find latest visionOS Simulator
      id: find_simulator
      run: |
        RUNTIME_ID=$(xcrun simctl list runtimes xros --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No visionOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available visionOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "SIMULATOR_DESTINATION=platform=visionOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Run tests on visionOS
      timeout-minutes: 10
      run: |
        set -o pipefail
        xcodebuild test \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -skipMacroValidation \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO

# ============================================
# BADGES (shields.io)
# ============================================
#
# Build badges:
# ![iOS](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=iOS&job=build-ios)
# ![macOS](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=macOS&job=build-macos)
# ![tvOS](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=tvOS&job=build-tvos)
# ![watchOS](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=watchOS&job=build-watchos)
# ![visionOS](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=visionOS&job=build-visionos)
#
# Test badges:
# ![iOS Tests](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=iOS%20Tests&job=test-ios)
# ![macOS Tests](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=macOS%20Tests&job=test-macos)
# ![tvOS Tests](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=tvOS%20Tests&job=test-tvos)
# ![watchOS Tests](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=watchOS%20Tests&job=test-watchos)
# ![visionOS Tests](https://img.shields.io/github/actions/workflow/status/aeastr/SwiftEmoji/ci.yml?label=visionOS%20Tests&job=test-visionos)
