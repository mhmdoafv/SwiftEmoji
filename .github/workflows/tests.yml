name: Tests

on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      build_run_id:
        description: 'Build workflow run ID to use artifacts from'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run Tests
    runs-on: macos-26
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts
        path: DerivedData/Build/Products
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ github.event.inputs.build_run_id || github.event.workflow_run.id }}

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Find latest iOS Simulator
      id: find_simulator
      run: |
        # Find the latest iOS simulator runtime and an available device
        RUNTIME_ID=$(xcrun simctl list runtimes ios --json | jq -r '.runtimes | sort_by(.version) | last | .identifier')
        if [ -z "$RUNTIME_ID" ] || [ "$RUNTIME_ID" == "null" ]; then
          echo "::error::No iOS runtime found."
          exit 1
        fi
        DEVICE_ID=$(xcrun simctl list devices --json | jq -r --arg RT_ID "$RUNTIME_ID" '.devices[$RT_ID] | map(select(.isAvailable)) | .[0].udid')
        if [ -z "$DEVICE_ID" ] || [ "$DEVICE_ID" == "null" ]; then
          echo "::error::No available iOS simulator device found for runtime $RUNTIME_ID."
          exit 1
        fi
        echo "Found iOS Simulator Runtime: $RUNTIME_ID"
        echo "Found iOS Simulator Device UDID: $DEVICE_ID"
        echo "SIMULATOR_DESTINATION=platform=iOS Simulator,id=$DEVICE_ID" >> $GITHUB_OUTPUT

    - name: Run tests without building
      timeout-minutes: 5
      run: |
        set -o pipefail
        echo "Using simulator destination: ${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}"
        xcodebuild test-without-building \
          -scheme SwiftEmoji-Package \
          -destination "${{ steps.find_simulator.outputs.SIMULATOR_DESTINATION }}" \
          -derivedDataPath DerivedData
