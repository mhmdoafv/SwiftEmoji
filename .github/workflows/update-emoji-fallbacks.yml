name: Update Emoji Fallbacks

on:
  # Run quarterly - first day of Jan, Apr, Jul, Oct at 00:00 UTC
  # Unicode emoji releases are typically in September, CLDR updates spring/fall
  schedule:
    - cron: '0 0 1 1,4,7,10 *'

  # Allow manual trigger (run after major Unicode releases)
  workflow_dispatch:
    inputs:
      locales:
        description: 'Locales to update (comma-separated, or "all")'
        required: false
        default: 'en,ar,de,es,fr,ja,ko,pt,ru,zh,zh-Hant'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-fallbacks:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Build CLI
        run: swift build --product BuildEmojiIndex

      - name: Determine locales
        id: locales
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            LOCALES="${{ github.event.inputs.locales }}"
          else
            # Default locales for scheduled runs
            LOCALES="en,ar,de,es,fr,ja,ko,pt,ru,zh,zh-Hant"
          fi
          echo "locales=$LOCALES" >> $GITHUB_OUTPUT

      - name: Update fallback files
        run: |
          LOCALES="${{ steps.locales.outputs.locales }}"

          if [ "$LOCALES" = "all" ]; then
            swift run BuildEmojiIndex --source blended --all-locales
          else
            swift run BuildEmojiIndex --source blended --locales "$LOCALES"
          fi

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet Sources/SwiftEmojiIndex/Resources/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update emoji fallback data'
          title: 'Update emoji fallback data (${{ steps.date.outputs.date }})'
          body: |
            This PR updates the bundled emoji fallback files from upstream sources.

            **Sources:**
            - [Unicode CLDR](https://github.com/unicode-org/cldr-json) - Localized emoji names
            - [GitHub Gemoji](https://github.com/github/gemoji) - Shortcodes and keywords

            **Locales updated:** ${{ steps.locales.outputs.locales }}

            ---
            *This PR was automatically generated by the update-emoji-fallbacks workflow.*
          branch: chore/update-emoji-fallbacks
          delete-branch: true
          labels: |
            dependencies
            automated
